<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ›¸ãé †ãƒã‚¹ã‚¯ ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</title>
<style>
  body {
    font-family: "Noto Sans JP", sans-serif;
    background: #f5f5f5;
    margin: 0;
    padding: 20px;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }

  h1 {
    color: #4c8f3a;
    text-align: center;
  }

  .controls {
    margin: 20px 0;
    padding: 15px;
    background: #f9f9f9;
    border-radius: 5px;
  }

  .control-group {
    margin: 10px 0;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  label {
    font-weight: bold;
    min-width: 120px;
  }

  select, input[type="range"] {
    padding: 5px;
    border: 1px solid #ccc;
    border-radius: 3px;
  }

  input[type="range"] {
    width: 200px;
  }

  .canvas-wrapper {
    display: flex;
    gap: 20px;
    margin: 20px 0;
    justify-content: center;
    flex-wrap: wrap;
  }

  .canvas-container {
    text-align: center;
  }

  .canvas-container h3 {
    margin: 10px 0;
    color: #333;
  }

  canvas {
    border: 2px solid #4c8f3a;
    border-radius: 5px;
    display: block;
    margin: 0 auto;
  }

  .stroke-toggles {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin: 15px 0;
  }

  .stroke-toggle {
    padding: 8px 15px;
    border: 2px solid #ccc;
    border-radius: 5px;
    cursor: pointer;
    background: white;
    font-weight: bold;
    transition: all 0.2s;
  }

  .stroke-toggle.active {
    background: #4c8f3a;
    color: white;
    border-color: #4c8f3a;
  }

  .stroke-toggle.stroke-1 { border-color: #e8717e; }
  .stroke-toggle.stroke-1.active { background: #e8717e; border-color: #e8717e; }
  
  .stroke-toggle.stroke-2 { border-color: #58b86f; }
  .stroke-toggle.stroke-2.active { background: #58b86f; border-color: #58b86f; }
  
  .stroke-toggle.stroke-3 { border-color: #5b80a4; }
  .stroke-toggle.stroke-3.active { background: #5b80a4; border-color: #5b80a4; }
  
  .stroke-toggle.stroke-4 { border-color: #b575a5; }
  .stroke-toggle.stroke-4.active { background: #b575a5; border-color: #b575a5; }

  .info {
    margin: 15px 0;
    padding: 10px;
    background: #e8f5e9;
    border-left: 4px solid #4c8f3a;
    border-radius: 3px;
  }

  .char-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
    gap: 10px;
    margin: 20px 0;
  }

  .char-button {
    padding: 10px;
    background: white;
    border: 2px solid #4c8f3a;
    border-radius: 5px;
    font-size: 20px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .char-button:hover {
    background: #4c8f3a;
    color: white;
  }

  .char-button.selected {
    background: #4c8f3a;
    color: white;
  }
</style>
</head>
<body>

<div class="container">
  <h1>ğŸ“ æ›¸ãé †ãƒã‚¹ã‚¯ ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</h1>
  
  <div class="info">
    <strong>ä½¿ã„æ–¹:</strong> æ–‡å­—ã‚’é¸æŠã—ã¦ã€å„ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ï¼ˆç”»ï¼‰ã®ãƒã‚¹ã‚¯é ˜åŸŸã‚’ç¢ºèªã§ãã¾ã™ã€‚<br>
    ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§å„ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚
  </div>

  <div class="controls">
    <div class="control-group">
      <label>é¸æŠä¸­ã®æ–‡å­—:</label>
      <span id="selectedChar" style="font-size: 24px; font-weight: bold; color: #4c8f3a;">ã‚</span>
    </div>

    <div class="control-group">
      <label>ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤é€æ˜åº¦:</label>
      <input type="range" id="opacitySlider" min="0" max="100" value="70">
      <span id="opacityValue">70%</span>
    </div>

    <div class="control-group">
      <label>è¡¨ç¤ºã™ã‚‹ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯:</label>
      <div class="stroke-toggles" id="strokeToggles">
        <div class="stroke-toggle stroke-1 active" data-stroke="1">1ç”»ç›®</div>
        <div class="stroke-toggle stroke-2 active" data-stroke="2">2ç”»ç›®</div>
        <div class="stroke-toggle stroke-3 active" data-stroke="3">3ç”»ç›®</div>
        <div class="stroke-toggle stroke-4 active" data-stroke="4">4ç”»ç›®</div>
      </div>
    </div>
  </div>

  <div class="char-grid" id="charGrid"></div>

  <div class="canvas-wrapper">
    <div class="canvas-container">
      <h3>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”»åƒ</h3>
      <canvas id="templateCanvas" width="300" height="300"></canvas>
    </div>

    <div class="canvas-container">
      <h3>ãƒã‚¹ã‚¯é ˜åŸŸï¼ˆè‰²åˆ†ã‘ï¼‰</h3>
      <canvas id="maskCanvas" width="300" height="300"></canvas>
    </div>

    <div class="canvas-container">
      <h3>é‡ã­åˆã‚ã›</h3>
      <canvas id="overlayCanvas" width="300" height="300"></canvas>
    </div>
  </div>

  <div class="info" id="strokeInfo">
    ç”»æ•°æƒ…å ±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
  </div>
</div>

<script src="strokeMaskData.js"></script>
<script>
const chars = "ã‚ã„ã†ãˆãŠã‹ããã‘ã“ã•ã—ã™ã›ããŸã¡ã¤ã¦ã¨ãªã«ã¬ã­ã®ã¯ã²ãµã¸ã»ã¾ã¿ã‚€ã‚ã‚‚ã‚„ã‚†ã‚ˆã‚‰ã‚Šã‚‹ã‚Œã‚ã‚ã‚’ã‚“".split("");
let currentChar = "ã‚";
let visibleStrokes = [true, true, true, true];
let overlayOpacity = 0.7;

const STROKE_COLORS = [
  { r: 232, g: 113, b: 126, name: "èµ¤ï¼ˆ1ç”»ç›®ï¼‰" },
  { r: 88,  g: 184, b: 111, name: "ç·‘ï¼ˆ2ç”»ç›®ï¼‰" },
  { r: 91,  g: 128, b: 164, name: "é’ï¼ˆ3ç”»ç›®ï¼‰" },
  { r: 181, g: 117, b: 165, name: "ç´«ï¼ˆ4ç”»ç›®ï¼‰" }
];

// ã‚­ãƒ£ãƒ³ãƒã‚¹å–å¾—
const templateCanvas = document.getElementById('templateCanvas');
const maskCanvas = document.getElementById('maskCanvas');
const overlayCanvas = document.getElementById('overlayCanvas');
const templateCtx = templateCanvas.getContext('2d');
const maskCtx = maskCanvas.getContext('2d');
const overlayCtx = overlayCanvas.getContext('2d');

// æ–‡å­—ã‚°ãƒªãƒƒãƒ‰ä½œæˆ
const charGrid = document.getElementById('charGrid');
chars.forEach(char => {
  const btn = document.createElement('div');
  btn.className = 'char-button';
  btn.textContent = char;
  if (char === currentChar) btn.classList.add('selected');
  btn.onclick = () => selectChar(char);
  charGrid.appendChild(btn);
});

// ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ãƒˆã‚°ãƒ«
document.querySelectorAll('.stroke-toggle').forEach(toggle => {
  toggle.addEventListener('click', () => {
    const strokeIndex = parseInt(toggle.dataset.stroke) - 1;
    visibleStrokes[strokeIndex] = !visibleStrokes[strokeIndex];
    toggle.classList.toggle('active');
    render();
  });
});

// é€æ˜åº¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
const opacitySlider = document.getElementById('opacitySlider');
const opacityValue = document.getElementById('opacityValue');
opacitySlider.addEventListener('input', () => {
  overlayOpacity = opacitySlider.value / 100;
  opacityValue.textContent = opacitySlider.value + '%';
  render();
});

function decodeBase64Map(base64) {
  const binary = atob(base64);
  const len = binary.length;
  const arr = new Uint8Array(len);
  for (let i = 0; i < len; i++) {
    arr[i] = binary.charCodeAt(i);
  }
  return arr;
}

function selectChar(char) {
  currentChar = char;
  document.getElementById('selectedChar').textContent = char;
  
  // ãƒœã‚¿ãƒ³ã®é¸æŠçŠ¶æ…‹æ›´æ–°
  document.querySelectorAll('.char-button').forEach(btn => {
    btn.classList.toggle('selected', btn.textContent === char);
  });
  
  render();
}

function render() {
  const data = window.strokeMaskData?.[currentChar];
  if (!data) {
    document.getElementById('strokeInfo').textContent = 'ã“ã®æ–‡å­—ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“';
    return;
  }

  const { width, height, strokeCount, map, strokePixels } = data;
  const strokeMap = decodeBase64Map(map);

  // æƒ…å ±è¡¨ç¤º
  let infoText = `ç”»æ•°: ${strokeCount} / ãƒã‚¹ã‚¯ã‚µã‚¤ã‚º: ${width}Ã—${height}px<br>`;
  for (let i = 0; i < strokeCount; i++) {
    const color = STROKE_COLORS[i];
    infoText += `${i + 1}ç”»ç›®: ${strokePixels[i]}ãƒ”ã‚¯ã‚»ãƒ« (${color.name})<br>`;
  }
  document.getElementById('strokeInfo').innerHTML = infoText;

  // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºèª¿æ•´
  const displaySize = 300;
  const scaleX = displaySize / width;
  const scaleY = displaySize / height;

  // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”»åƒæç”»
  templateCtx.clearRect(0, 0, displaySize, displaySize);
  const img = new Image();
  img.onload = () => {
    templateCtx.drawImage(img, 0, 0, displaySize, displaySize);
    renderOverlay();
  };
  img.src = `./practice_files/${currentChar}.png`;

  // ãƒã‚¹ã‚¯æç”»
  maskCtx.clearRect(0, 0, displaySize, displaySize);
  const maskImageData = maskCtx.createImageData(displaySize, displaySize);
  
  for (let y = 0; y < displaySize; y++) {
    for (let x = 0; x < displaySize; x++) {
      const srcX = Math.floor(x / scaleX);
      const srcY = Math.floor(y / scaleY);
      const srcIdx = srcY * width + srcX;
      const strokeIdx = strokeMap[srcIdx];
      
      if (strokeIdx > 0 && strokeIdx <= 4 && visibleStrokes[strokeIdx - 1]) {
        const color = STROKE_COLORS[strokeIdx - 1];
        const destIdx = (y * displaySize + x) * 4;
        maskImageData.data[destIdx] = color.r;
        maskImageData.data[destIdx + 1] = color.g;
        maskImageData.data[destIdx + 2] = color.b;
        maskImageData.data[destIdx + 3] = 255;
      }
    }
  }
  maskCtx.putImageData(maskImageData, 0, 0);

  renderOverlay();
}

function renderOverlay() {
  overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
  
  // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”»åƒã‚’æç”»
  const img = new Image();
  img.onload = () => {
    overlayCtx.drawImage(img, 0, 0, 300, 300);
    
    // ãƒã‚¹ã‚¯ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
    overlayCtx.globalAlpha = overlayOpacity;
    overlayCtx.drawImage(maskCanvas, 0, 0);
    overlayCtx.globalAlpha = 1.0;
  };
  img.src = `./practice_files/${currentChar}.png`;
}

// åˆæœŸæç”»
render();
</script>

</body>
</html>

